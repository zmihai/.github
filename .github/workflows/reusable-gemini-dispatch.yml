name: 'ðŸ”€ Reusable Gemini Dispatch'

on:
  workflow_call:
    inputs:
      language:
        description: 'The project language (javascript, python, php)'
        required: true
        type: string

      language-version:
        description: 'Language version to use (20, 3.11, etc)'
        required: true
        type: string

      working-directory:
        description: 'Working directory for commands'
        required: false
        type: string
        default: '.'

      # CI directives
      ci-run-lint:
        description: 'Run linting'
        required: false
        type: boolean
        default: true
      ci-run-test:
        description: 'Run tests'
        required: false
        type: boolean
        default: true
      ci-run-build:
        description: 'Run build'
        required: false
        type: boolean
        default: true
      ci-build-before-test:
        description: 'Run build before tests'
        required: false
        type: boolean
        default: false

      # Dependency scan directives
      scan-dependencies:
        description: 'Scan dependencies for vulnerabilities'
        required: false
        type: boolean
        default: true
      scan-code:
        description: 'Run CodeQL analysis'
        required: false
        type: boolean
        default: false

    secrets:
      GEMINI_API_KEY:
        description: 'Required for calling the Gemini API'
        required: true
      CALLER_GITHUB_TOKEN:
        description: 'Required for the workflow to update PRs'
        required: true

defaults:
  run:
    shell: 'bash'

jobs:
  debugger:
    if: |-
     ${{ fromJSON(vars.DEBUG || vars.ACTIONS_STEP_DEBUG || false) }}
    runs-on: 'ubuntu-latest'
    permissions:
      contents: 'read'
    steps:
      - name: 'Print context for debugging'
        env:
          DEBUG_event_name: '${{ github.event_name }}'
          DEBUG_event__action: '${{ github.event.action }}'
          DEBUG_event__comment__author_association: '${{ github.event.comment.author_association }}'
          DEBUG_event__issue__author_association: '${{ github.event.issue.author_association }}'
          DEBUG_event__pull_request__author_association: '${{ github.event.pull_request.author_association }}'
          DEBUG_event__review__author_association: '${{ github.event.review.author_association }}'
          DEBUG_event: '${{ toJSON(github.event) }}'
        run: |-
          env | grep '^DEBUG_'


  dispatch:
    # For PRs: only if not from a fork
    # For issues: only on open/reopen
    # For comments: only if user types @gemini-cli and is OWNER/MEMBER/COLLABORATOR
    if: |-
      (
        github.event_name == 'pull_request' &&
        github.event.pull_request.head.repo.fork == false
      ) || (
        github.event_name == 'issues' &&
        contains(fromJSON('["opened", "reopened"]'), github.event.action)
      ) || (
        github.event.sender.type == 'User' &&
        startsWith(github.event.comment.body || github.event.review.body || github.event.issue.body, '@gemini-cli') &&
        contains(fromJSON('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.comment.author_association || github.event.review.author_association || github.event.issue.author_association)
      )
    runs-on: 'ubuntu-latest'
    permissions:
      contents: 'read'
      issues: 'write'
      pull-requests: 'write'
    outputs:
      command: '${{ steps.extract_command.outputs.command }}'
      request: '${{ steps.extract_command.outputs.request }}'
      additional_context: '${{ steps.extract_command.outputs.additional_context }}'
      issue_number: '${{ github.event.pull_request.number || github.event.issue.number }}'
    steps:
      - name: 'Mint identity token'
        id: 'mint_identity_token'
        if: |-
          ${{ vars.APP_ID }}
        uses: 'actions/create-github-app-token@a8d616148505b5069dccd32f177bb87d7f39123b' # ratchet:actions/create-github-app-token@v2
        with:
          app-id: '${{ vars.APP_ID }}'
          private-key: '${{ secrets.APP_PRIVATE_KEY }}'
          permission-contents: 'read'
          permission-issues: 'write'
          permission-pull-requests: 'write'

      - name: 'Extract command'
        id: 'extract_command'
        uses: 'actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea' # ratchet:actions/github-script@v7
        env:
          EVENT_TYPE: '${{ github.event_name }}.${{ github.event.action }}'
          REQUEST: '${{ github.event.comment.body || github.event.review.body || github.event.issue.body }}'
          ACTOR: '${{ github.actor }}'
        with:
          script: |
            const eventType = process.env.EVENT_TYPE;
            const request = process.env.REQUEST;
            const actor = process.env.ACTOR;
            let additionalContext = '';
            core.setOutput('request', request);

            if (eventType === 'pull_request.opened') {
              if (actor === 'dependabot[bot]') {
                core.setOutput('command', 'review-and-merge');
              } else {
                core.setOutput('command', 'review');
              }
            } else if (request.startsWith("@gemini-cli /review")) {
              if (request.startsWith("@gemini-cli /review-and-merge")) {
                core.setOutput('command', 'review-and-merge');
                additionalContext = request.replace(/^@gemini-cli \/review-and-merge/, '').trim();
              } else {
                core.setOutput('command', 'review');
                additionalContext = request.replace(/^@gemini-cli \/review/, '').trim();
              }
              core.setOutput('additional_context', additionalContext);
            } else if (request.startsWith("@gemini-cli /merge")) {
              core.setOutput('command', 'merge');
            } else {
              core.setOutput('command', 'fallthrough');
            }

      - name: 'Acknowledge request'
        env:
          GITHUB_TOKEN: '${{ steps.mint_identity_token.outputs.token || secrets.CALLER_GITHUB_TOKEN || secrets.GITHUB_TOKEN || github.token }}'
          ISSUE_NUMBER: '${{ github.event.pull_request.number || github.event.issue.number }}'
          MESSAGE: |-
            ðŸ¤– Hi @${{ github.actor }}, I've received your request, and I'm working on it now! You can track my progress [in the logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for more details.
          REPOSITORY: '${{ github.repository }}'
        run: |-
          gh issue comment "${ISSUE_NUMBER}" \
            --body "${MESSAGE}" \
            --repo "${REPOSITORY}"


  review:
    needs: 'dispatch'
    if: |-
      ${{ needs.dispatch.outputs.command == 'review' || needs.dispatch.outputs.command == 'review-and-merge' }}
    uses: './.github/workflows/gemini-review.yml'
    permissions:
      contents: 'read'
      id-token: 'write'
      issues: 'write'
      pull-requests: 'write'
    with:
      additional_context: '${{ needs.dispatch.outputs.additional_context }}'
      command: '${{ needs.dispatch.outputs.command }}'
      issue_number: '${{ needs.dispatch.outputs.issue_number }}'
    secrets: 'inherit'

  merge:
    needs:
      - 'dispatch'
      - 'review'
    if: |-
      ${{ needs.dispatch.outputs.command == 'merge' || needs.review.outputs.command == 'review-and-merge' }}
    uses: './.github/workflows/gemini-merge.yml'
    permissions:
      security-events: 'write'
      contents: 'write'
      actions: 'read'
      id-token: 'write'
      issues: 'write'
      pull-requests: 'write'
    with:
      pull_request_number: '${{ needs.dispatch.outputs.issue_number }}'
      language: ${{ inputs.language }}
      language-version: ${{ inputs.language-version }}
      working-directory: ${{ inputs.working-directory }}
      ci-run-lint: ${{ inputs.ci-run-lint }}
      ci-run-test: ${{ inputs.ci-run-test }}
      ci-run-build: ${{ inputs.ci-run-build }}
      ci-build-before-test: ${{ inputs.ci-build-before-test }}
      scan-dependencies: ${{ inputs.scan-dependencies }}
      scan-code: ${{ inputs.scan-code }}
      review_summary: '${{ needs.review.outputs.review_summary }}'
    secrets: 'inherit'

  fallthrough:
    needs:
      - 'dispatch'
      - 'review'
      - 'merge'
    if: |-
      ${{ always() && !cancelled() && (failure() || needs.dispatch.outputs.command == 'fallthrough') }}
    runs-on: 'ubuntu-latest'
    permissions:
      contents: 'read'
      issues: 'write'
      pull-requests: 'write'
    steps:
      - name: 'Mint identity token'
        id: 'mint_identity_token'
        if: |-
          ${{ vars.APP_ID }}
        uses: 'actions/create-github-app-token@a8d616148505b5069dccd32f177bb87d7f39123b' # ratchet:actions/create-github-app-token@v2
        with:
          app-id: '${{ vars.APP_ID }}'
          private-key: '${{ secrets.APP_PRIVATE_KEY }}'
          permission-contents: 'read'
          permission-issues: 'write'
          permission-pull-requests: 'write'

      - name: 'Send failure comment'
        env:
          GITHUB_TOKEN: '${{ steps.mint_identity_token.outputs.token || secrets.CALLER_GITHUB_TOKEN || secrets.GITHUB_TOKEN || github.token }}'
          ISSUE_NUMBER: '${{ github.event.pull_request.number || github.event.issue.number }}'
          MESSAGE: |-
            ðŸ¤– I'm sorry @${{ github.actor }}, but I was unable to process your request. Please [see the logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for more details.
          REPOSITORY: '${{ github.repository }}'
        run: |-
          gh issue comment "${ISSUE_NUMBER}" \
            --body "${MESSAGE}" \
            --repo "${REPOSITORY}"
